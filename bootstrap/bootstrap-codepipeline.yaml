AWSTemplateFormatVersion: '2010-09-09'
Description: 'CodePipeline for 3-Tier Infrastructure'

Parameters:
  ProjectName:
    Type: String
    Default: 'three-tier'
    Description: Project name for resource naming

  GitHubRepositoryId:
    Type: String
    Default: 'kalavinka123/study-awsdva-3tier-project'
    Description: 'GitHub repository Id. The format: "GitHubOwner/GitHubRepo"'

  GitHubDefaultBranch:
    Type: String
    Default: 'feature/codepipeline' ## TODO: release/**
    Description: GitHub default branch name

Resources:
  # S3 Bucket for Pipeline Artifacts
  CodePipelineArtifactStoreBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-codepipeline-artifacts-${AWS::Region}-${AWS::AccountId}'

  CodePipelineArtifactStoreBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CodePipelineArtifactStoreBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Sid: DenyUnEncryptedObjectUploads
            Effect: Deny
            Principal: '*'
            Action: s3:PutObject
            Resource: !Join [ '', [ !GetAtt CodePipelineArtifactStoreBucket.Arn, '/*' ] ]
            Condition:
              StringNotEquals: 
                s3:x-amz-server-side-encryption: aws:kms
          -
            Sid: DenyInsecureConnections
            Effect: Deny
            Principal: '*'
            Action: s3:*
            Resource: !Join [ '', [ !GetAtt CodePipelineArtifactStoreBucket.Arn, '/*' ] ]
            Condition:
              Bool:
                aws:SecureTransport: false

  # CodePipeline Service Role
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-codepipeline-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals: 
                aws:SourceAccount: !Sub ${AWS::AccountId}
      Policies:
        - PolicyName: CodePipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - !GetAtt CodePipelineArtifactStoreBucket.Arn
                  - !Sub '${CodePipelineArtifactStoreBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref GithubConnection
              - Effect: Allow
                Action:
                  - cloudformation:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: '*'

  # IAM Role for CloudFormation
  CloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-cloudformation-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess

  # CodeConnection
  GithubConnection:
    Type: AWS::CodeStarConnections::Connection
    Properties:
      ConnectionName: !Sub '${ProjectName}-codeconnection-github'
      ProviderType: GitHub
      # Tags:
      # - Key: Project
      #   Value: ProjectB

  # CodePipeline
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub '${ProjectName}-infra-pipeline'
      RoleArn: !GetAtt CodePipelineServiceRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref CodePipelineArtifactStoreBucket

      Triggers:
        - ProviderType: CodeStarSourceConnection
          GitConfiguration:
            SourceActionName: GitHubSource
            Push:
              - Branches:
                  Includes:
                    - !Ref GitHubDefaultBranch ## TODO: release/**
                  Excludes:
                    - main
                FilePaths:
                  Excludes:
                    - '**/README.md'
                    - '**/LICENSE'
                    - '**/CONTRIBUTING.md'
                    - '.github'

      Stages:
        - Name: Source
          Actions:
            - Name: GitHubSource
              InputArtifacts: []
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: '1'
                Provider: CodeStarSourceConnection
              OutputArtifacts:
                - Name: SourceOutputArtifact
              Configuration:
                BranchName: !Ref GitHubDefaultBranch
                ConnectionArn: !Ref GithubConnection
                FullRepositoryId: !Ref GitHubRepositoryId
                OutputArtifactFormat: CODE_ZIP
              RunOrder: 1

        - Name: Deploy
          Actions:
            - Name: ProvisionInfra
              InputArtifacts:
                - Name: SourceOutputArtifact
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: '1'
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE ## TODO: CHANGE_SET_REPLACE, CHANGE_SET_EXECUTE 
                StackName: !Sub '${ProjectName}-Infra'
                TemplatePath: SourceOutputArtifact::stacks/test.yaml
                RoleArn: !GetAtt CloudFormationRole.Arn
                Capabilities: CAPABILITY_NAMED_IAM
              RunOrder: 1